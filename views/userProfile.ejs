<%- include('partials/logoutToolbar') %>

<!-- üîô Back to Your Own Profile -->
    <div style="margin: 1rem 0;">
      <a href="/user/profile">
        <button style="background-color: #ffccf9; border: none; padding: 0.5rem 1rem; border-radius: 10px; font-weight: bold; cursor: pointer;">
          ‚¨ÖÔ∏è Back to My Profile
        </button>
      </a>
    </div>

<div class="center-box">
  <h2><%= user.username %>'s Profile</h2>
  <img src="<%= user.profilePic %>" width="100" style="border-radius: 50%;"/>
  <div class="center-box">
    <h2><%= user.username %>'s Profile</h2>
    <img src="<%= user.profilePic %>" width="100" style="border-radius: 50%;" />
  
    <% if (user.profileSong) { %>
      <div style="margin-top: 1rem;">
        <iframe
          src="<%= user.profileSong %>"
          width="300"
          height="80"
          frameborder="0"
          allowtransparency="true"
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
          style="border-radius: 12px;"
        ></iframe>
      </div>
    <% } %>
    

    <% if (user.profileSong) { %>
      <div id="songPrompt" style="
        position: fixed;
        top: 30%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff0fb;
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 0 20px rgba(0,0,0,0.15);
        z-index: 9999;
        text-align: center;
      ">
        <p style="margin-bottom: 1rem; font-weight: bold;">üé∂ <%= user.username %> has a profile song!</p>
        <button onclick="playSong()" style="padding: 0.5rem 1rem; margin-right: 1rem; border: none; border-radius: 8px; background-color: #b9fbc0;">Yes</button>
        <button onclick="dismissSong()" style="padding: 0.5rem 1rem; border: none; border-radius: 8px; background-color: #ffc2d1;">No</button>
      </div>
    
      <div id="musicPlayer" style="display: none; margin-top: 1rem;">
        <iframe
          id="musicIframe"
          src=""
          width="300"
          height="80"
          frameborder="0"
          allowtransparency="true"
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
          style="border-radius: 12px;"
        ></iframe>
      </div>
    
      <script>
        function playSong() {
          const songURL = "<%= user.profileSong.includes('?') ? user.profileSong + '&autoplay=1' : user.profileSong + '?autoplay=1' %>";
          document.getElementById('musicIframe').src = songURL;
          document.getElementById('musicPlayer').style.display = 'block';
          document.getElementById('songPrompt').style.display = 'none';
        }
    
        function dismissSong() {
          document.getElementById('songPrompt').style.display = 'none';
        }
      </script>
    <% } %>
     

<!-- üîÅ Add/Remove Friend Button -->
<% if (user._id.toString() !== session.userId.toString()) { %>
  <% const isFriend = user.friends.some(f => f._id.toString() === session.userId.toString()); %>
  <% const hasRequested = user.friendRequests.some(r => r._id.toString() === session.userId.toString()); %>

  <% if (isFriend) { %>
    <form action="/user/unfriend/<%= user._id %>" method="POST" style="margin-top: 1rem;">
      <button type="submit">‚ùå Unfriend</button>
    </form>
  <% } else if (hasRequested) { %>
    <p style="color: gray; margin-top: 1rem;">üíå Friend Request Sent</p>
  <% } else { %>
    <form action="/user/request/<%= user._id %>" method="POST" style="margin-top: 1rem;">
      <button type="submit">‚ûï Send Friend Request</button>
    </form>
  <% } %>
<% } %>

<div>
  <h3><%= user.username %>'s Posts</h3>
  <% posts.forEach(post => { %>
    <div class="post">
      <a href="/user/<%= post.user._id %>"><strong><%= post.user.username %></strong></a>
      <p><%= post.content %></p>
      <small><%= post.createdAt.toLocaleDateString() %> @ <%= post.createdAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %></small>
      <form action="/user/like/<%= post._id %>" method="POST">
        <button type="submit">‚ù§Ô∏è</button> <%= post.likes.length %> likes
      </form>
    </div>
  <% }) %>
</div>
