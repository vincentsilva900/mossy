<%- include('partials/logoutToolbar') %>

<!-- üîô Back to Your Own Profile -->
    <div style="margin: 1rem 0;">
      <a href="/user/profile">
        <button style="background-color: #ffccf9; border: none; padding: 0.5rem 1rem; border-radius: 10px; font-weight: bold; cursor: pointer;">
          ‚¨ÖÔ∏è Back to My Profile
        </button>
      </a>
    </div>

<div class="center-box">
  <h2><%= user.username %>'s Profile</h2>
  <img src="<%= user.profilePic %>" width="100" style="border-radius: 50%;"/>
  <div class="center-box">
    <h2><%= user.username %>'s Profile</h2>
    <img src="<%= user.profilePic %>" width="100" style="border-radius: 50%;" />
    
    
    <% if (user.profileSong) { %>
      <!-- üå∏ Profile Song Header -->
      <div style="
        background-color: #ffebf7;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        border: 2px dashed #ff99c8;
        margin-top: 1rem;
        width: fit-content;
        max-width: 90%;
      ">
        <h4 style="
          margin: 0 0 0.5rem 0;
          font-size: 1rem;
          color: #c9184a;
          font-family: 'Comic Sans MS', cursive;
        ">
          üé∂ <%= user.username %>'s Profile Song:
        </h4>
    
        <iframe
          src="<%= user.profileSong.includes('?') ? user.profileSong + '&autoplay=0' : user.profileSong + '?autoplay=0' %>"
          width="300"
          height="80"
          frameborder="0"
          allowtransparency="true"
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
          style="border-radius: 12px;"
        ></iframe>
      </div>
    <% } %>
    
 
<!-- üîÅ Add/Remove Friend Button -->
<% if (user._id.toString() !== session.userId.toString()) { %>
  <% const isFriend = user.friends.some(f => f._id.toString() === session.userId.toString()); %>
  <% const hasRequested = user.friendRequests.some(r => r._id.toString() === session.userId.toString()); %>

  <% if (isFriend) { %>
    <form action="/user/unfriend/<%= user._id %>" method="POST" style="margin-top: 1rem;">
      <button type="submit">‚ùå Unfriend</button>
    </form>
  <% } else if (hasRequested) { %>
    <p style="color: gray; margin-top: 1rem;">üíå Friend Request Sent</p>
  <% } else { %>
    <form action="/user/request/<%= user._id %>" method="POST" style="margin-top: 1rem;">
      <button type="submit">‚ûï Send Friend Request</button>
    </form>
  <% } %>
<% } %>

<div>
  <h3><%= user.username %>'s Posts</h3>
  <% posts.forEach(post => { %>
    <div class="post">
      <a href="/user/<%= post.user._id %>"><strong><%= post.user.username %></strong></a>
      <p><%= post.content %></p>
      <small><%= post.createdAt.toLocaleDateString() %> @ <%= post.createdAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %></small>
      <form action="/user/like/<%= post._id %>" method="POST">
        <button type="submit">‚ù§Ô∏è</button> <%= post.likes.length %> likes
      </form>
    </div>
  <% }) %>
</div>
